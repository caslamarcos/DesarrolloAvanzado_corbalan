{{! Lista con filtros + paginación + botón agregar al carrito }}
{{! Nota: asumimos que ya creaste un carrito y tenés su ID para testear (reemplaza CART_ID en el fetch) }}

<h2>Productos</h2>

<form method="get" action="/products" style="margin:12px 0;">
  <input type="text" name="query" placeholder="query (p.ej. category:Electro / status:true)" value="{{queryCurrent}}" />
  <select name="sort">
    <option value="">Sin orden</option>
    <option value="asc" {{#if (eq sortCurrent "asc")}}selected{{/if}}>Precio ↑</option>
    <option value="desc" {{#if (eq sortCurrent "desc")}}selected{{/if}}>Precio ↓</option>
  </select>
  <input type="number" name="limit" min="1" value="{{limitCurrent}}" />
  <button type="submit">Aplicar</button>
</form>

<ul>
{{#each products}}
  <li style="margin-bottom:10px; border-bottom:1px solid #ddd; padding-bottom:10px;">
    <a href="/products/{{this._id}}"><strong>{{this.title}}</strong></a>
    — ${{this.price}} — {{#if this.status}}Disponible{{else}}Sin stock{{/if}} — {{this.category}}
    <div style="margin-top:6px;">
      <button onclick="addToCart('{{this._id}}')">Agregar al carrito</button>
    </div>
  </li>
{{/each}}
</ul>

<div style="margin-top:12px;">
  {{#if hasPrevPage}} <a href="{{prevLink}}">⬅️ Anterior</a> {{/if}}
  <span style="margin:0 8px;">Página {{page}} de {{totalPages}}</span>
  {{#if hasNextPage}} <a href="{{nextLink}}">Siguiente ➡️</a> {{/if}}
</div>

<script>
  async function addToCart(pid) {
    const cartId = localStorage.getItem('cartId');
    if (!cartId) {
      // crear carrito una vez
      const resCart = await fetch('/api/carts', { method:'POST' });
      const dataCart = await resCart.json();
      localStorage.setItem('cartId', dataCart.payload._id);
    }
    const cid = localStorage.getItem('cartId');
    const res = await fetch(`/api/carts/${cid}/product/${pid}`, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ quantity: 1 })
    });
    if (res.ok) alert('Producto agregado');
    else alert('Error al agregar');
  }
</script>